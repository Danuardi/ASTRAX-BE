<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Phantom Sign Test</title>
</head>
<body>
  <h3>Phantom Sign Test</h3>
  <div>
    <button id="connectBtn">Connect Phantom</button>
    <button id="signBtn" disabled>Sign Server Nonce & Request Token</button>
  </div>
  <pre id="output" style="white-space:pre-wrap;border:1px solid #ddd;padding:12px;margin-top:12px;max-width:900px;"></pre>

  <script>
    const out = (v) => { document.getElementById('output').textContent = typeof v === 'string' ? v : JSON.stringify(v, null, 2); };

    function getProvider() {
      if (window?.phantom?.solana?.isPhantom) {
        const provider = window.phantom.solana;
        // Set to devnet
        provider.connect({ onlyIfTrusted: true }).catch(() => {});
        if (provider.connection) {
          provider.connection.commitment = 'confirmed';
          provider.connection.rpcUrl = 'https://api.devnet.solana.com';
        }
        return provider;
      }
      if (window?.solana?.isPhantom) {
        const provider = window.solana;
        // Set to devnet
        provider.connect({ onlyIfTrusted: true }).catch(() => {});
        if (provider.connection) {
          provider.connection.commitment = 'confirmed';
          provider.connection.rpcUrl = 'https://api.devnet.solana.com';
        }
        return provider;
      }
      return null;
    }

    async function connectWallet() {
      const provider = getProvider();
      if (!provider) return out('Phantom wallet not found. Install from https://phantom.app/');
      try {
        const resp = await provider.connect();
        const pk = provider.publicKey?.toString() || resp.publicKey?.toString();
        out({ connected: true, publicKey: pk });
        document.getElementById('signBtn').disabled = false;
      } catch (err) {
        out({ error: err?.message || String(err) });
      }
    }

    async function signAndRequestToken() {
      const provider = getProvider();
      if (!provider) return out('Phantom wallet not found.');

      try {
        // 1) Request nonce from backend (POST /api/auth/nonce { publicKey })
        const publicKey = provider.publicKey?.toString();
        if (!publicKey) return out('No publicKey from provider. Connect first.');

        const nonceResp = await fetch('/api/auth/nonce', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ publicKey })
        });
        const nonceJson = await nonceResp.json();
        if (!nonceResp.ok) return out({ error: 'Failed to obtain nonce', details: nonceJson });
        out({ nonceMessage: nonceJson.message });

        // 2) Encode message and get signature from Phantom
        const encoder = new TextEncoder();
        const messageBytes = encoder.encode(nonceJson.message);
        const signed = await provider.signMessage(messageBytes, 'utf8');
        const sigBytes = signed?.signature || signed; // handle different shapes

        // 3) Encode signature as base64 (safer for browser transport)
        function uint8ToBase64(u8) {
          let binary = '';
          for (let i = 0; i < u8.length; i++) binary += String.fromCharCode(u8[i]);
          return btoa(binary);
        }
        const signatureBase64 = uint8ToBase64(sigBytes instanceof Uint8Array ? sigBytes : new Uint8Array(sigBytes));

        // 4) Send signature to /api/auth/verify
        const verifyRes = await fetch('/api/auth/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            publicKey, 
            signature: signatureBase64,
            message: nonceJson.message // include message for verification
          })
        });

        const verifyJson = await verifyRes.json();
        if (!verifyRes.ok) return out({ error: 'Verification failed', details: verifyJson });

        out({ success: true, server: verifyJson });

        // store tokens for quick testing
        if (verifyJson.token) localStorage.setItem('accessToken', verifyJson.token);
        if (verifyJson.refreshToken) localStorage.setItem('refreshToken', verifyJson.refreshToken);

      } catch (err) {
        out({ error: err?.message || String(err) });
      }
    }

    document.getElementById('connectBtn').addEventListener('click', connectWallet);
    document.getElementById('signBtn').addEventListener('click', signAndRequestToken);
  </script>
</body>
</html>
